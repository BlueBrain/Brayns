include:
  - project: hpc/gitlab-pipelines
    file: spack-build-components.gitlab-ci.yml
    

variables:
   bb5_account: proj3
   bb5_duration: "2:00:00"
   DATADIR: /tmp
   SALLOC_ACCOUNT: proj3
   SBATCH_ACCOUNT: proj3
   SLURM_ACCOUNT: proj3
   SLURM_CPUS_PER_TASK: 72
   SPACK_PACKAGE: brayns
   SPACK_PACKAGE_NAME: brayns
   SPACK_PACKAGE_COMPILER: gcc
   SPACK_PACKAGE_REF: ''
   SPACK_PACKAGE_SPEC: +brion ^ospray%intel@19.1.3.304 target=x86_64 ^intel-tbb%intel@19.1.3.304 
    

spack_setup:
  extends: .spack_setup_ccache
  timeout: 2h


brayns-spack-build:
  extends: .spack_build
  stage: test
  timeout: 2h
   

brayns-spack-test:
  extends: .spack_build
  stage: test
  timeout: 2h
  script:
   - module load unstable spack git
   - SPACK_FULL_SPEC="${SPACK_PACKAGE}@develop${SPACK_PACKAGE_COMPILER:+%}${SPACK_PACKAGE_COMPILER}${SPACK_PACKAGE_SPEC}${SPACK_PACKAGE_DEPENDENCIES:+ }${SPACK_PACKAGE_DEPENDENCIES}"
   - spack dev-build --test=root ${SPACK_FULL_SPEC}

  

