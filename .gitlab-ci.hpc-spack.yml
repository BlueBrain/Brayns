include:
  - project: hpc/gitlab-pipelines
    file: spack-build-components.gitlab-ci.yml
    

variables:
   bb5_account: proj3
   DATADIR: /tmp
   SALLOC_ACCOUNT: proj3
   SBATCH_ACCOUNT: proj3
   SLURM_ACCOUNT: proj3
   SLURM_CPUS_PER_TASK: 72
   SPACK_PACKAGE: brayns
   SPACK_PACKAGE_NAME: brayns
   SPACK_PACKAGE_COMPILER: gcc
   SPACK_PACKAGE_REF: ''
   SPACK_PACKAGE_SPEC: +brion ^ospray@1.8.5%intel
    

spack_setup:
  extends: .spack_setup_ccache


brayns-spack-build:
  extends: .spack_build
  stage: test
   

brayns-spack-test:
  extends: .spack_build
  stage: test
  script:
   - module load unstable git
   - git clone -c feature.manyFiles=true https://github.com/BlueBrain/spack.git
   - . spack/share/spack/setup-env.sh
   - mkdir fake_home
   - export HOME=${PWD}/fake_home
   - mkdir -p ~/.spack
   - ln -s /gpfs/bbp.cscs.ch/apps/hpc/jenkins/config/*.yaml ~/.spack
   - export SPACK_INSTALL_PREFIX=${HOME}/software
   - SPACK_FULL_SPEC="${SPACK_PACKAGE}@develop${SPACK_PACKAGE_COMPILER:+%}${SPACK_PACKAGE_COMPILER}${SPACK_PACKAGE_SPEC}${SPACK_PACKAGE_DEPENDENCIES:+ }${SPACK_PACKAGE_DEPENDENCIES}"
   - spack build-dev --test=root ${SPACK_FULL_SPEC}

  

