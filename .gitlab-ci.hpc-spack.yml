include:
  - project: hpc/gitlab-pipelines
    file: spack-build-components.gitlab-ci.yml


variables:
  BRAYNS_COMMIT: ${CI_COMMIT_SHA}
  bb5_account: proj3
  bb5_duration: "2:00:00"
  DATADIR: /tmp
  SALLOC_ACCOUNT: proj3
  SBATCH_ACCOUNT: proj3
  SLURM_ACCOUNT: proj3
  SLURM_CPUS_PER_TASK: 72
  SPACK_PACKAGE: brayns
  SPACK_PACKAGE_NAME: brayns
  SPACK_PACKAGE_COMPILER: gcc
  SPACK_PACKAGE_REF: ''
  SPACK_PACKAGE_SPEC: +brion ^ospray@2.9.0%intel ^intel-tbb%intel


spack_setup:
  extends: .spack_setup_ccache
  timeout: 2h


brayns-spack-build:
  extends: .spack_build
  stage: test
  timeout: 2h


brayns-spack-test:
  extends: .spack_test
  needs: ["brayns-spack-build"]
  timeout: 2h
  script:
    - cd ${SPACK_BUILD_DIR}
    - spack build-env ${SPACK_FULL_SPEC} -- ninja tests


brayns-python-test:
  extends: .spack_test
  needs: ["brayns-spack-build"]
  timeout: 10 minutes
  script:
    - cd ${SPACK_SOURCE_DIR}/python
    - module load unstable
    - module load python
    - python -m venv pythonvenv
    - source pythonvenv/bin/activate
    - python setup.py sdist
    - pip install dist/$(ls dist)
    - python -m unittest discover -v --locals -s tests -p test_*.py
    - deactivate
